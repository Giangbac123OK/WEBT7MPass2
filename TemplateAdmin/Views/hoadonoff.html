<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>H√≥a ƒë∆°n b√°n h√†ng</title>
  <!-- CDN Bootstrap CSS -->
  <link 
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" 
    rel="stylesheet"
  />
  <!-- Bootstrap Icons -->
  <link 
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css"
  />
  <!-- SweetAlert2 CSS (n·∫øu mu·ªën style popup) -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css"
  />
  <style>
    /* ==== Layout c∆° b·∫£n ==== */
    .main {
      display: flex;
      min-height: 100vh;
      background: #f4f4f6;     /* n·ªÅn flat x√°m nh·∫°t */
    }
    .main-content {
      margin-top: 60px;
      margin-left: 250px;
      flex: 1;
      padding: 20px;
      transition: margin-left 0.3s ease;
    }
    .main-content.open {
      margin-left: 0;
    }
  
    /* ==== Ti√™u ƒë·ªÅ h√≥a ƒë∆°n ==== */
    .invoice-title {
      color: #343a40;           /* ƒëen ƒë·∫≠m tr√™n n·ªÅn s√°ng */
      margin-bottom: 15px;
      font-weight: 700;
      text-align: center;
    }
  
    /* ==== Tabs h√≥a ƒë∆°n ==== */
    .invoice-tab-item {
      display: flex;
      align-items: center;
      position: relative;
      margin-right: 10px;
    }
    .invoice-tab-item .nav-link {
      flex-grow: 1;
      padding-right: 10px;
    }
    .invoice-tab-item .close-btn {
      padding: 0;
      width: 16px;
      height: 16px;
      font-size: 0.75rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #dc3545;
      color: white;
      border: none;
      cursor: pointer;
      line-height: 1;
    }
    .invoice-tab-item .close-btn:hover {
      background-color: #c82333;
    }
    .nav-tabs .nav-item {
      display: flex;
      align-items: center;
    }
    .nav-tabs .nav-link {
      padding-right: 25px; /* ƒê·∫£m b·∫£o kh√¥ng gian cho n√∫t "X" */
      position: relative;
    }
  
    /* ==== Card body m√†u t·ªëi cho form ch√≠nh ==== */
    .custom-card-body {
      padding: 20px;
      background-image: linear-gradient(#1f1f1f, #c10c9a2d);
    }
    .custom-card-header-secondary {
      background-color: #C10C99;
      color: white;
    }
  
    /* ==== N√∫t ch√≠nh ==== */
    .custom-btn-primary {
      background-color: #28a745;   /* xanh l√° */
      border-color: #28a745;
    }
    .custom-btn-primary:hover {
      background-color: #218838;
      border-color: #1e7e34;
    }
  
    /* ==== N√∫t nh·ªè th√™m h√≥a ƒë∆°n ==== */
    .custom-btn-success {
      border-radius: 50%;
      width: 40px;
      height: 40px;
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .custom-btn-success:hover {
      color: #C10C99;
      background-color: white;
    }
    .custom-btn-success:disabled {
      color: #585257;
    }
  
    /* ==== Search v√† form-control ==== */
    .row.align-items-center {
      margin-top: 1rem;
    }
    .row .form-control {
      width: calc(100% - 1rem);
      display: inline-block;
    }
  
    /* ==== T√™n kh√°ch h√†ng hi·ªÉn th·ªã ==== */
    p.mb-0.customer-name {
      margin-left: 10px;
      display: inline-block;
      color: #343a40;           /* m√†u ƒëen ƒë·ªÉ n·ªïi tr√™n n·ªÅn s√°ng */
    }
  
    /* ==== Danh s√°ch k·∫øt qu·∫£ t√¨m ki·∫øm ==== */
    .search-results {
      max-width: 100%;
      width: 300px;
      position: absolute;
      background-color: #fff;
      border: 1px solid #ddd;
      z-index: 1000;
      border-radius: 4px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    .search-result-item {
      display: flex;
      align-items: center;
      padding: 5px;
      cursor: pointer;
    }
    .search-result-item:hover {
      background-color: #f0f0f0;
    }
    .search-result-item div {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
  
    /* ==== B·∫£ng s·∫£n ph·∫©m ==== */
    .table-invoice thead th {
      background: #343a40;       /* header t·ªëi ƒë·ªÉ t∆∞∆°ng ph·∫£n */
      color: #fff;
      vertical-align: middle;
    }
    .table-invoice tbody td {
      vertical-align: middle;
    }
    .quantity-input {
      max-width: 70px;
    }
  
    /* ==== C√°c n√∫t c·∫£nh b√°o & m·∫∑c ƒë·ªãnh ==== */
    .btn-danger {
      background-color: #dc3545;
      border-color: #dc3545;
    }
    .btn-danger:hover {
      background-color: #c82333;
      border-color: #bd2130;
    }
    .btn-primary {
      background-color: #0d6efd;
      border-color: #0d6efd;
    }
    .btn-primary:hover {
      background-color: #0b5ed7;
      border-color: #0a58ca;
    }
  
    /* ==== Card chung ==== */
    .card-flat {
      border: 1px solid #dee2e6;
      border-radius: .4rem;
      background: #fff;
      margin-bottom: 1rem;
    }
    .card-flat .card-header {
      background: #343a40;
      color: #fff;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .card-flat .card-body {
      padding: 1rem;
    }
  
    /* ==== Container ==== */
    .container {
      max-width: 100vw;
      margin: 0;
      padding: 0;
    }
  
    /* ==== Close button tr√™n tab ==== */
    .customCloseBtn {
      position: absolute;
      right: 10px;
      top: 13px;
      background-color: transparent !important;
      color: #C10C99 !important;
    }
  
    /* ==== Link tab ==== */
    .customNavlink {
      color: #C10C99;
    }
    .custom-card-body {
  background: #1f1f1f!important;
  background-image: none !important;
  padding: 100px; /* n·∫øu b·∫°n mu·ªën padding c·ªßa .card-body m·∫∑c ƒë·ªãnh */
}
/* ==== Tab ‚ÄúTh√™m h√≥a ƒë∆°n ch·ªù‚Äù ==== */
.add-tab-item {
  margin-right: 0; /* kh√¥ng c·∫ßn kho·∫£ng c√°ch th·ª´a */
}
.add-tab-item .custom-add-tab {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 40px;
  height: 40px;
  padding: 0;
  border: 1px solid #dee2e6;
  border-bottom-color: transparent;            /* ƒë·ªÉ g·∫Øn v·ªõi ph·∫ßn content */
  border-top-left-radius: .25rem;
  border-top-right-radius: .25rem;
  background-color: #e9ecef;                   /* gi·ªëng tab inactive */
  color: #6c757d;                               /* x√°m ƒë·∫≠m */
  cursor: pointer;
}

/* hover */
.add-tab-item .custom-add-tab:hover:not(:disabled) {
  background-color: #dee2e6;
  color: #495057;
}

/* tr·∫°ng th√°i disabled */
.add-tab-item .custom-add-tab:disabled {
  opacity: .5;
  cursor: not-allowed;
}

</style>
  
</head>
<body>
  <div id="app">
    <!-- ====== Ph·∫ßn template ch√≠nh, copy t·ª´ <template> trong .vue ====== -->
    <div class="main">
      <main :class="{ open: !isSidebarOpen }" class="main-content">
        <div class="container">
          <h1 class="invoice-title">T·∫°o h√≥a ƒë∆°n b√°n h√†ng</h1>
          <div >
            <div class="card-body custom-card-body">
              <!-- Tabs for Invoices -->
              <ul class="nav nav-tabs mb-3" id="invoice-tabs" role="tablist">
                <li
                  class="nav-item invoice-tab-item"
                  v-for="(invoice, index) in invoices"
                  :key="invoice.id"
                >
                  <a
                    class="nav-link flex-grow-1 customNavlink"
                    :class="{ active: activeInvoiceId === invoice.id }"
                    href="#"
                    @click.prevent="setActiveInvoice(invoice.id)"
                    style="padding-right: 35px;"
                  >
                    H√≥a ƒë∆°n {{ index + 1 }}
                     <span
        class="tab-close"
        @click.stop.prevent="removeInvoice(invoice.id)"
        title="X√≥a h√≥a ƒë∆°n"
      >√ó</span>
                  </a>
                  <button
                    class="btn btn-danger btn-sm close-btn ms-2 customCloseBtn"
                    @click.prevent="removeInvoice(invoice.id)"
                    title="X√≥a H√≥a ƒë∆°n"
                  >
                    <i class="pi pi-times" style="font-size: 12px;"></i>
                  </button>
                </li>
                <li class="nav-item add-tab-item">
                  <button
                    class="nav-link custom-add-tab"
                    title="Th√™m h√≥a ƒë∆°n ch·ªù"
                    @click="addInvoice"
                    :disabled="invoices.length >= maxInvoices"
                  >
                    <i class="bi bi-file-earmark-plus" style="font-size: 1.2rem;"></i>
                  </button>
                </li>
                
              </ul>

              <!-- Main Content Row -->
              <div class="row">
                <div class="col-lg-4 col-md-5 col-sm-12">
                  <div class="card card-flat mb-4">
                    <div class="card-header header-dark">
                      <span>Th√¥ng tin kh√°ch h√†ng</span>
                      <i class="bi bi-person-fill"></i>
                    </div>
                
                    <div class="card-body">
                      <form>
                        <!-- Customer Type -->
                        <div class="mb-3">
                          <label for="customerType" class="form-label"><strong>Lo·∫°i Kh√°ch H√†ng:</strong></label>
                          <select
                            class="form-select"
                            id="customerType"
                            v-model="activeInvoice.customer.type"
                            @change="handleCustomerTypeChange(activeInvoice.id)"
                          >
                            <option value="regular">Kh√°ch L·∫ª</option>
                            <option value="loyal">Kh√°ch H√†ng Th√¢n Thi·∫øt</option>
                          </select>
                        </div>

                        <!-- Customer Name for Regular Customers -->
                        <div class="mb-3" v-if="activeInvoice.customer.type === 'regular'">
                          <label for="customerName" class="form-label"><strong>T√™n Kh√°ch H√†ng:</strong></label>
                          <input
                            type="text"
                            class="form-control"
                            id="customerName"
                            v-model="activeInvoice.customer.name"
                            placeholder="Nh·∫≠p t√™n kh√°ch h√†ng"
                            @input="updateCustomerName(activeInvoice.id)"
                          />
                        </div>

                        <!-- Customer Search for Loyal Customers -->
                        <div class="mb-3 position-relative" v-else>
                          <label for="customerSearch" class="form-label"><strong>T√¨m Ki·∫øm Kh√°ch H√†ng:</strong></label>
                          <input
                            type="text"
                            class="form-control"
                            id="customerSearch"
                            v-model="activeInvoice.customer.searchQuery"
                            placeholder="T√¨m ki·∫øm t√™n, SƒêT, email..."
                            @input="searchCustomer(activeInvoice.id)"
                            autocomplete="off"
                          />
                          <div v-if="activeInvoice.customer.searchResults.length" class="mt-1 search-results shadow">
                            <div
                              v-for="customer in activeInvoice.customer.searchResults"
                              :key="customer.id"
                              class="search-result-item p-2 border-bottom bg-white"
                              @click="selectCustomer(activeInvoice.id, customer)"
                            >
                              <strong>{{ customer.ten }}</strong> - {{ customer.sdt }} - {{ customer.email }}
                            </div>
                          </div>
                        </div>

                        <!-- Payment Method -->
                        <div class="mb-3">
                          <label for="paymentMethod" class="form-label"><strong>Ph∆∞∆°ng Th·ª©c Thanh To√°n:</strong></label>
                          <select
                          class="form-select"
                          id="paymentMethod"
                          v-model="activeInvoice.customer.paymentMethod"
                        >
                          <option
                            v-for="pt in paymentMethods"
                            :key="pt.id"
                            :value="pt.id"
                          >
                            {{ pt.tenpttt }}
                          </option>
                        </select>
                        
                        </div>

                        <!-- Vouchers for Loyal Customers -->
                        <div class="mb-3" v-if="activeInvoice.customer.type === 'loyal'">
                          <label for="selectedVoucher" class="form-label"><strong>Gi·∫£m Gi√°:</strong></label>
                          <select
                            class="form-select"
                            id="selectedVoucher"
                            v-model="activeInvoice.customer.selectedVoucher"
                            @change="calculateDiscount(activeInvoice.id)"
                          >
                            <option value="">Ch·ªçn gi·∫£m gi√°</option>
                            <option
                              v-for="voucher in activeInvoice.customer.vouchers"
                              :key="voucher.id"
                              :value="voucher"
                            >
                              {{ voucher.mota }}
                            </option>
                          </select>
                        </div>

                       
                      </form>

                      <hr />

                      <div class="invoice-summary">
                        <p>
                          <strong>T·ªïng ti·ªÅn h√†ng:</strong>
                          <span class="float-end">{{ formatCurrency(totalAmountBeforeDiscount) }}</span>
                        </p>
                        <p>
                          <strong>T·ªïng Gi·∫£m Gi√°:</strong>
                          <span class="float-end">{{ formatCurrency(totalDiscount) }}</span>
                        </p>
                        <p>
                          <strong>T·ªïng ti·ªÅn thanh to√°n:</strong>
                          <span class="float-end">{{ formatCurrency(totalAmount) }}</span>
                        </p>
                         <!-- Points Used for Loyal Customers -->
                         <div class="mb-3" v-if="activeInvoice.customer.type === 'loyal'">
                          <label for="pointsUsed" class="form-label"><strong>ƒêi·ªÉm S·ª≠ D·ª•ng:</strong></label>
                          <div class="d-flex justify-content-between align-items-center">
                            <span>ƒêi·ªÉm c√≥ th·ªÉ s·ª≠ d·ª•ng: {{ activeInvoice.customer.availablePoints }}</span>
                            <input
                              type="number"
                              class="form-control w-50"
                              id="pointsUsed"
                              v-model.number="activeInvoice.customer.pointsUsed"
                              @input="applyPoints(activeInvoice.id)"
                              min="0"
                              :max="activeInvoice.customer.availablePoints"
                              placeholder="0"
                            />
                          </div>
                        </div>
                        <div class="mb-3 mt-3">
                          <label for="cashGiven" class="form-label"><strong>S·ªë Ti·ªÅn Kh√°ch ƒê∆∞a:</strong></label>
                          <input
                            type="text"
                            class="form-control"
                            id="cashGiven"
                            v-model="activeInvoice.customer.cashGivenFormatted"
                            placeholder="Nh·∫≠p s·ªë ti·ªÅn kh√°ch ƒë∆∞a"
                            @input="onCashGivenInput(activeInvoice.id)"
                          />
                        </div>
                        <p>
                          <strong>Ti·ªÅn th·ª´a:</strong>
                          <span class="float-end">{{ formatCurrency(changeAmount) }}</span>
                        </p>
                        <button
                          class="btn custom-btn-primary w-100 mt-3"
                          @click="submitInvoice"
                        >
                          Thanh to√°n
                        </button>
                      </div>
                    </div>
                  </div> <!-- End of .row -->
                </div>

                <div class="col-lg-8 col-md-7 col-sm-12">
                  <div class="row align-items-center mb-3">
                    <div class="position-relative w-100">
                      <input
                        type="text"
                        class="form-control"
                        v-model="activeInvoice.productSearchQuery"
                        placeholder="T√¨m ki·∫øm s·∫£n ph·∫©m..."
                        @input="searchProduct"
                        autocomplete="off"
                        style="min-width: 100%;"
                      />
                      <p class="mb-2 customer-name" style="color: white; margin-top: 20px;">
                        <strong>T√™n kh√°ch h√†ng:</strong> {{ activeInvoice.customer.selectedCustomerName || 'Ch∆∞a ch·ªçn' }}
                      </p>
                      <div v-if="activeInvoice.productSearchResults.length" class="search-results">
                        <div
                          v-for="product in activeInvoice.productSearchResults"
                          :key="product.id"
                          class="search-result-item"
                          @click="addProductToInvoice(product)"
                        >
                      
                          <div>
                            <strong> {{ formatProductCode(product.id) }} - {{ product.tenSanpham }}</strong>
                            <br />
                            {{ formatCurrency(product.giaBan) }}
                            <br />
                            T·ªìn kho: {{ product.soluong }}
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="card card-flat">
                    <div class="card-header header-dark">
                      Danh s√°ch s·∫£n ph·∫©m
                    </div>
                    <div class="card-body p-0">
                      <div class="table-responsive">
                        <table class="table table-hover m-0 table-invoice">
                          <thead>
                            <tr>
                              <th>T√™n SP</th>
                              <th>Gi√° b√°n</th>
                              <th>Gi√° gi·∫£m</th>
                              <th>Ph√¢n lo·∫°i</th>
                              <th class="text-center">SL</th>
                              <th>Th√†nh ti·ªÅn</th>
                              <th></th>
                            </tr>
                          </thead>
                          
                      <tbody>
                        <tr
                          v-for="item in activeInvoice.products || []"
                          :key="item.id"
                        >
                          <td>{{ item.tensp }}</td>
                          <td>{{ formatCurrency(item.giaban) }}</td>
                          <td>{{ formatCurrency(item.giagiam) }}</td>
                          <td>
                            <select
                              class="form-select form-select-sm attribute-select"
                              v-model="item.selectedAttribute.idspct"
                              @change="updatePrice(activeInvoice.id, item)"
                              :disabled="item.isLocked"
                            >
                              <option
                                v-for="attr in getAvailableAttributesForProduct(item)"
                                :key="attr.idspct"
                                :value="attr.idspct"
                              >
                                {{ attr.spctAttributes }}
                              </option>
                            </select>
                          </td>
                          <td>
                            <input
                            type="number"
                            class="form-control form-control-sm quantity-input"
                            v-model.number="item.quantity"
                            @input="onQuantityInput(activeInvoice.id, item, $event)"
                            @blur="onQuantityBlur(activeInvoice.id, item)"   
                            min="1"
                          />

                          </td>
                          <td>{{ formatCurrency(item.totalPrice) }}</td>
                          <td>
                            <button
                              class="btn btn-danger btn-sm"
                              @click="removeProduct(activeInvoice.id, item.id)"
                            >
                              X√≥a
                            </button>
                          </td>
                        </tr>
                        <tr v-if="activeInvoice.products.length === 0">
                          <td colspan="7" class="text-center">Ch∆∞a c√≥ s·∫£n ph·∫©m n√†o trong h√≥a ƒë∆°n.</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>

              </div> <!-- End of .row -->
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>


  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
  <!-- Bootstrap Bundle (bao g·ªìm Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  // ====== Code logic, thay th·∫ø "script setup" b·∫±ng createApp() ======
  const { createApp, ref, computed, onMounted } = Vue;

  createApp({
    setup() {
      // Kh·ªüi t·∫°o danh s√°ch h√≥a ƒë∆°n
      const invoices = ref([
        {
          id: 1,
          products: [],
          productSearchQuery: '',
          productSearchResults: [],
          customer: {
            type: 'regular',
            name: '',
            selectedCustomerId: null,
            selectedCustomerName: '',
            searchQuery: '',
            searchResults: [],
            availablePoints: 0,
            pointsUsed: 0,
            maxPointsUsable: 0,
            vouchers: [],
            selectedVoucher: null,
            paymentMethod: 'cash',
            cashGiven: 0,
            cashGivenFormatted: '',
          }
        }
      ]);
      const ACCOUNT_NAME = 'DOAN THI PHUONG THAO';
      const ACCOUNT_NO   = '1023577418';
      const BANK_CODE    = 'VCB';       
      const BANK_TRANSFER_ID = 2;
      const paymentMethods = ref([]); 
      const invoiceCount = ref(1);
      const maxInvoices = 3;
      const activeInvoiceId = ref(1);
      const isSidebarOpen = ref(true);

      const activeInvoice = computed(() => invoices.value.find(inv => inv.id === activeInvoiceId.value));
      const totalAmountBeforeDiscount = computed(() => {
        if (!activeInvoice.value) return 0;
        return activeInvoice.value.products.reduce((sum, p) => sum + p.totalPrice, 0);
      });
      const voucherDiscount = computed(() => {
        if (!activeInvoice.value) return 0;
        const invoice = activeInvoice.value;
        let discount = 0;
        if (invoice.customer.selectedVoucher) {
          const v = invoice.customer.selectedVoucher;
          if (v.donvi === 0) {
            discount = v.giatri;
          } else if (v.donvi === 1) {
            discount = (totalAmountBeforeDiscount.value * v.giatri) / 100;
          }
        }
        return Math.min(discount, totalAmountBeforeDiscount.value);
      });
      const totalDiscount = computed(() => {
        if (!activeInvoice.value) return 0;
        return Math.min(voucherDiscount.value + activeInvoice.value.customer.pointsUsed, totalAmountBeforeDiscount.value);
      });

      const totalAmount = computed(() => totalAmountBeforeDiscount.value - totalDiscount.value);

      const changeAmount = computed(() => {
        if (!activeInvoice.value) return 0;
        return (activeInvoice.value.customer.cashGiven || 0) - totalAmount.value;
      });

      
      async function loadPaymentMethods() {
        try {
          const res = await fetch(
            "https://localhost:7196/api/Phuongthucthanhtoans/active"
          );
          if (!res.ok) throw new Error("Kh√¥ng th·ªÉ l·∫•y ph∆∞∆°ng th·ª©c thanh to√°n");
          paymentMethods.value = await res.json();   
          console.log( paymentMethods.value )
        } catch (err) {
          console.error(err);
          paymentMethods.value = [];                 
        }
      }

      function formatProductCode(id) {
        return 'SP' + String(id).padStart(5, '0');
      }

      function formatCurrency(amount) {
        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
      }

      // H√†m th√™m s·∫£n ph·∫©m v√†o h√≥a ƒë∆°n (v·ªõi y√™u c·∫ßu ch·ªçn ph√¢n lo·∫°i)
      async function addProductToInvoice(product) {
        const invoice = activeInvoice.value;
        if (!invoice) {
          Swal.fire('L·ªói', 'Kh√¥ng t√¨m th·∫•y h√≥a ƒë∆°n hi·ªán t·∫°i.', 'error');
          return;
        }

        try {
          const response = await fetch(
            `https://localhost:7196/api/Sanphams/active-products-with-attributes/Admin?id=${product.id}`
          );
          let attributesData = await response.json();

          // L·ªçc c√°c ph√¢n lo·∫°i ƒë√£ ƒë∆∞·ª£c th√™m v√†o h√≥a ƒë∆°n
          const existingAttributes = invoice.products
            .filter(p => p.productId === product.id)
            .map(p => p.selectedAttribute.idspct);
          const availableAttributes = attributesData.filter(
            attr => !existingAttributes.includes(attr.idspct)
          );

          if (availableAttributes.length === 0) {
            Swal.fire(
              'Th√¥ng b√°o',
              'T·∫•t c·∫£ ph√¢n lo·∫°i c·ªßa s·∫£n ph·∫©m n√†y ƒë√£ ƒë∆∞·ª£c th√™m v√†o h√≥a ƒë∆°n!',
              'info'
            );
            return;
          }

          // T·∫°o ƒë·ªëi t∆∞·ª£ng cho l·ª±a ch·ªçn ph√¢n lo·∫°i
          const classificationOptions = availableAttributes.reduce((options, attr) => {
            options[attr.idspct] = attr.spctAttributes;
            return options;
          }, {});

          // Hi·ªÉn th·ªã h·ªôp tho·∫°i ch·ªçn ph√¢n lo·∫°i
          const { value: selectedId } = await Swal.fire({
            title: 'Ch·ªçn ph√¢n lo·∫°i s·∫£n ph·∫©m',
            input: 'select',
            inputOptions: classificationOptions,
            inputPlaceholder: 'Ch·ªçn ph√¢n lo·∫°i',
            showCancelButton: true,
            inputValidator: (value) => {
              return new Promise((resolve) => {
                if (value) {
                  resolve();
                } else {
                  resolve('B·∫°n c·∫ßn ch·ªçn m·ªôt ph√¢n lo·∫°i!');
                }
              });
            },
          });

          if (!selectedId) {
            // Ng∆∞·ªùi d√πng h·ªßy ho·∫∑c kh√¥ng ch·ªçn
            return;
          }

          // selectedId t·ª´ string => number
          const selectedAttribute = availableAttributes.find(
            attr => attr.idspct === Number(selectedId)
          );
          if (!selectedAttribute) {
            Swal.fire('L·ªói', 'Ph√¢n lo·∫°i kh√¥ng h·ª£p l·ªá.', 'error');
            return;
          }

          const productPrice = selectedAttribute.giathoidiemhientai || product.giaBan;
          const newProduct = {
            id: Date.now(), // ID duy nh·∫•t cho s·∫£n ph·∫©m trong h√≥a ƒë∆°n
            productId: product.id,
            tensp: product.tenSanpham,
            giaban: product.giaBan,
            giagiam: productPrice,
            attributes: availableAttributes,
            selectedAttribute: selectedAttribute,
            quantity: 1,
            totalPrice: productPrice,
            isLocked: true 
          };

          invoice.products.push(newProduct);
          invoice.productSearchQuery = '';
          invoice.productSearchResults = [];

          Swal.fire('Th√†nh c√¥ng', 'ƒê√£ th√™m s·∫£n ph·∫©m v·ªõi ph√¢n lo·∫°i ƒë√£ ch·ªçn.', 'success');
        } catch (error) {
          console.error('L·ªói khi l·∫•y thu·ªôc t√≠nh s·∫£n ph·∫©m:', error);
          Swal.fire(
            'L·ªói',
            'Kh√¥ng th·ªÉ l·∫•y thu·ªôc t√≠nh c·ªßa s·∫£n ph·∫©m. Vui l√≤ng th·ª≠ l·∫°i sau.',
            'error'
          );
        }
      }
      function buildVietQR(amount, description = 'THANH TOAN HOA DON') {
  const params = new URLSearchParams({
    amount: amount,                                 // s·ªë ti·ªÅn VND
    addInfo: description.replace(/\s+/g, '%20'),    // n·ªôi dung chuy·ªÉn kho·∫£n
    accountName: ACCOUNT_NAME.replace(/\s+/g, '%20')
  }).toString();

  // URL t·ªõi ·∫£nh QR d·∫°ng png, host b·ªüi VietQR.io
  return `https://img.vietqr.io/image/${BANK_CODE}-${ACCOUNT_NO}-qr_only.png?${params}`;
}


      function removeProduct(invoiceId, productId) {
        const invoice = invoices.value.find(inv => inv.id === invoiceId);
        if (invoice) {
          invoice.products = invoice.products.filter(p => p.id !== productId);
        }
      }

      // C·∫≠p nh·∫≠t gi√° khi ƒë·ªïi ph√¢n lo·∫°i
      function updatePrice(invoiceId, product) {
        const invoice = invoices.value.find(inv => inv.id === invoiceId);
        if (invoice) {
          const selectedAttr = invoice.products
            .find(p => p.id === product.id)
            .attributes.find(attr => attr.idspct === product.selectedAttribute.idspct);
          if (selectedAttr) {
            product.giagiam = selectedAttr.giathoidiemhientai || product.giaban;
            product.totalPrice = product.giagiam * product.quantity;
          }
        }
      }

      // C·∫≠p nh·∫≠t t·ªïng ti·ªÅn khi thay ƒë·ªïi s·ªë l∆∞·ª£ng
      function updateTotal(invoiceId) {
        const invoice = invoices.value.find(inv => inv.id === invoiceId);
        if (invoice) {
          invoice.products.forEach(product => {
            const qty = Number(product.quantity) || 0;   // √©p sang s·ªë, '' ‚Üí 0
  product.totalPrice = product.giagiam * qty;
          });
        }
      }

      // L·∫•y ph√¢n lo·∫°i kh·∫£ d·ª•ng cho s·∫£n ph·∫©m trong b·∫£ng
      function getAvailableAttributesForProduct(product) {
        const existingAttributes = activeInvoice.value.products
          .filter(p => p.productId === product.productId && p.id !== product.id)
          .map(p => p.selectedAttribute.idspct);
        return product.attributes.filter(attr => !existingAttributes.includes(attr.idspct));
      }

      // Thay ƒë·ªïi lo·∫°i kh√°ch h√†ng
      function handleCustomerTypeChange(invoiceId) {
        const invoice = invoices.value.find(inv => inv.id === invoiceId);
        if (!invoice) return;
        invoice.customer.selectedCustomerId = null;
        invoice.customer.selectedCustomerName = '';
        invoice.customer.selectedVoucher = null;
        invoice.customer.vouchers = [];
        invoice.customer.pointsUsed = 0;

        if (invoice.customer.type === 'regular') {
          invoice.customer.availablePoints = 0;
        } else if (invoice.customer.type === 'loyal') {
          // N·∫øu c·∫ßn logic kh√°c th√¨ ƒë·∫∑t ·ªü ƒë√¢y
        }
      }

      // T√¨m ki·∫øm kh√°ch h√†ng
      function searchCustomer(invoiceId) {
        const invoice = invoices.value.find(inv => inv.id === invoiceId);
        if (!invoice) return;

        const searchQuery = invoice.customer.searchQuery.trim().toLowerCase();
        if (searchQuery === '') {
          invoice.customer.searchResults = [];
          return;
        }
        fetch(
          `https://localhost:7196/api/Khachhangs/searchByEmailSdtTen/Admin?keyword=${encodeURIComponent(searchQuery)}`
        )
          .then(response => response.json())
          .then(data => {
            invoice.customer.searchResults = data || [];
          })
          .catch(error => {
            console.error('L·ªói khi t√¨m ki·∫øm kh√°ch h√†ng:', error);
            invoice.customer.searchResults = [];
          });
      }

      // Ch·ªçn kh√°ch h√†ng
      function selectCustomer(invoiceId, customer) {
        const invoice = invoices.value.find(inv => inv.id === invoiceId);
        if (invoice) {
          invoice.customer.selectedCustomerId = customer.id;
          invoice.customer.selectedCustomerName = customer.ten;
          invoice.customer.availablePoints = customer.diemsudung || 0;
          invoice.customer.pointsUsed = 0; // reset khi ch·ªçn kh√°ch m·ªõi

          loadDiscountVouchers(invoiceId, customer.id);

          // X√≥a n·ªôi dung t√¨m ki·∫øm
          invoice.customer.searchQuery = '';
          invoice.customer.searchResults = [];
        }
      }

      // L·∫•y voucher gi·∫£m gi√° theo kh√°ch h√†ng
      function loadDiscountVouchers(invoiceId, customerId) {
        fetch(`https://localhost:7196/api/Giamgia/vouchers-by-customer/${customerId}/admin`)
          .then(response => response.json())
          .then(data => {
            const invoice = invoices.value.find(inv => inv.id === invoiceId);
            if (invoice) {
              const activeVouchers = data.filter(voucher => voucher.trangthai === 0);
              invoice.customer.vouchers = activeVouchers;
              if (activeVouchers.length === 0) {
                invoice.customer.vouchers = [];
              }
            }
          })
          .catch(error => {
            console.error('Error fetching vouchers by customer:', error);
            const invoice = invoices.value.find(inv => inv.id === invoiceId);
            if (invoice) {
              invoice.customer.vouchers = [];
            }
          });
      }

      // T√≠nh to√°n gi·∫£m gi√° d·ª±a tr√™n voucher
      function calculateDiscount(invoiceId) {
        const invoice = invoices.value.find(inv => inv.id === invoiceId);
        if (invoice) {
          const selectedVoucher = invoice.customer.selectedVoucher;
          if (selectedVoucher) {
            let discount = 0;
            if (selectedVoucher.donvi === 0) {
              discount = selectedVoucher.giatri;
            } else if (selectedVoucher.donvi === 1) {
              discount = (totalAmountBeforeDiscount.value * selectedVoucher.giatri) / 100;
            }
            invoice.customer.discount = Math.min(
              discount,
              totalAmountBeforeDiscount.value
            );
          }
        }
      }
      function applyPoints(invoiceId) {
        const invoice = invoices.value.find(inv => inv.id === invoiceId);
        if (!invoice) return;
        const available = invoice.customer.availablePoints;
        const maxByAmount = totalAmountBeforeDiscount.value - voucherDiscount.value;
        const requested = Number(invoice.customer.pointsUsed) || 0;
        invoice.customer.pointsUsed = Math.max(0, Math.min(requested, available, maxByAmount));
      }


      // X·ª≠ l√Ω nh·∫≠p s·ªë ti·ªÅn kh√°ch ƒë∆∞a
      function onCashGivenInput(invoiceId) {
        const invoice = invoices.value.find(inv => inv.id === invoiceId);
        if (!invoice) return;

        let value = invoice.customer.cashGivenFormatted.replace(/\D/g, '');
        if (value.length === 0) {
          invoice.customer.cashGiven = 0;
          invoice.customer.cashGivenFormatted = '';
          return;
        }

        const numericValue = parseInt(value, 10) || 0;
        invoice.customer.cashGiven = numericValue;
        invoice.customer.cashGivenFormatted = numericValue.toLocaleString('vi-VN');
      }
function onQuantityBlur(invoiceId, product) {
  // N·∫øu ng∆∞·ªùi d√πng b·ªè tr·ªëng r·ªìi click ra ngo√†i ‚Üí set v·ªÅ 1
  if (product.quantity === '' || product.quantity === null || product.quantity === undefined) {
    product.quantity = 1;
  }
  updateTotal(invoiceId);    // lu√¥n t√≠nh l·∫°i th√†nh ti·ªÅn
}
      // G·ª≠i y√™u c·∫ßu t·∫°o h√≥a ƒë∆°n
      async function submitInvoice() {
        const invoice = activeInvoice.value;
        if (!invoice) {
          Swal.fire('L·ªói', 'Kh√¥ng t√¨m th·∫•y h√≥a ƒë∆°n hi·ªán t·∫°i.', 'error');
          return;
        }
        if (!invoice.products || invoice.products.length === 0) {
          Swal.fire('L·ªói', 'H√≥a ƒë∆°n ch∆∞a c√≥ s·∫£n ph·∫©m. Vui l√≤ng th√™m s·∫£n ph·∫©m.', 'warning');
          return;
        }
        if (invoice.customer.type === 'loyal' && !invoice.customer.selectedCustomerId) {
          Swal.fire('L·ªói', 'Vui l√≤ng ch·ªçn th√¥ng tin kh√°ch h√†ng th√¢n thi·∫øt.', 'warning');
          return;
        }
        if (invoice.customer.paymentMethod !== BANK_TRANSFER_ID &&
      invoice.customer.cashGiven < totalAmount.value) {
    Swal.fire('L·ªói', 'S·ªë ti·ªÅn kh√°ch ƒë∆∞a kh√¥ng ƒë·ªß.', 'error'); return;
  }
  if (invoice.customer.paymentMethod === BANK_TRANSFER_ID) {
    const qrUrl = buildVietQR(totalAmount.value);

    const { isConfirmed } = await Swal.fire({
      title: 'Qu√©t m√£ ƒë·ªÉ chuy·ªÉn kho·∫£n',
      html: `
        <img src="${qrUrl}" style="width:260px;height:260px;margin-bottom:10px"/>
        <p>üëâ Vui l√≤ng chuy·ªÉn ƒë√∫ng <b>${formatCurrency(totalAmount.value)}</b><br/>
           N·ªôi dung: THANH TOAN HOA DON</p>`,
      showCancelButton: true,
      confirmButtonText: 'ƒê√£ chuy·ªÉn xong',
      cancelButtonText: 'H·ªßy'
    });

    if (!isConfirmed) return;   // Kh√°ch h·ªßy th√¨ d·ª´ng
  }

        // D·ªØ li·ªáu chi ti·∫øt s·∫£n ph·∫©m
        const productDetails = invoice.products.map(product => ({
          idspct: product.selectedAttribute.idspct,
          soluong: product.quantity,
          giasp: product.giaban,
          giamgia: product.selectedAttribute.giathoidiemhientai,
        }));

        let requestData;
        let apiUrl;
        if (invoice.customer.type === 'loyal') {
          const customerData = await fetchCustomerById(invoice.customer.selectedCustomerId);
          if (!customerData) {
            Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ l·∫•y th√¥ng tin kh√°ch h√†ng th√¢n thi·∫øt.', 'error');
            return;
          }
          const diemSuDung = invoice.customer.pointsUsed || 0; 
          apiUrl = `https://localhost:7196/api/Hoadons/create/khtt?diemSuDung=${diemSuDung}`;

          requestData = {
            idnv: 1,
            idkh: invoice.customer.selectedCustomerId || null,
            
            idpttt: invoice.customer.paymentMethod,
            tongtiencantra: totalAmount.value,
            tongtiensanpham: totalAmountBeforeDiscount.value,
            sdt: customerData || '',
            tonggiamgia: totalDiscount.value,
            idgg: invoice.customer.selectedVoucher ? invoice.customer.selectedVoucher.id : null,
            ghichu: '',
            sanPhamChiTiet: productDetails,
          };
        } else {
          apiUrl = 'https://localhost:7196/api/Hoadons/create/Admin';
          requestData = {
            idnv: 1,
            idpttt: invoice.customer.paymentMethod,
            tongtiencantra: totalAmount.value,
            tongtiensanpham: totalAmountBeforeDiscount.value,
            ghichu: '',
            sanPhamChiTiet: productDetails,
          };
        }

        try {
          const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestData),
          });
          if (!response.ok) {
            const error = await response.json();
            Swal.fire(
              'L·ªói',
              error.message || 'Kh√¥ng th·ªÉ t·∫°o h√≥a ƒë∆°n. Vui l√≤ng th·ª≠ l·∫°i sau.',
              'error'
            );
            return;
          }
          Swal.fire({
            icon: 'success',
            title: 'T·∫°o h√≥a ƒë∆°n th√†nh c√¥ng!',
            text: 'H√≥a ƒë∆°n ƒë√£ ƒë∆∞·ª£c l∆∞u.',
            confirmButtonText: 'ƒê√≥ng',
          }).then(() => {
            resetInvoice(activeInvoiceId.value);
          });
        } catch (error) {
          console.error('L·ªói khi g·ª≠i y√™u c·∫ßu:', error);
          Swal.fire('L·ªói', 'Kh√¥ng th·ªÉ g·ª≠i y√™u c·∫ßu. Vui l√≤ng ki·ªÉm tra l·∫°i API.', 'error');
        }
      }

      // L·∫•y kh√°ch h√†ng theo ID
      async function fetchCustomerById(idkh) {
        try {
          const response = await fetch(
            `https://localhost:7196/api/Khachhangs/${idkh}/Admin`,
            {
              method: 'GET',
              headers: { 'Content-Type': 'application/json' },
            }
          );
          if (!response.ok) {
            const error = await response.json();
            console.error('L·ªói khi l·∫•y th√¥ng tin kh√°ch h√†ng:', error);
            return null;
          }
          const customerData = await response.json();
          return customerData.sdt;
        } catch (error) {
          console.error('L·ªói khi g·ªçi API:', error);
          return null;
        }
      }

      // C·∫≠p nh·∫≠t t√™n kh√°ch h√†ng (Kh√°ch l·∫ª)
      function updateCustomerName(invoiceId) {
        const invoice = invoices.value.find(inv => inv.id === invoiceId);
        if (invoice) {
          invoice.customer.selectedCustomerName = invoice.customer.name;
        }
      }

      // T√¨m ki·∫øm s·∫£n ph·∫©m
      function searchProduct() {
        const invoice = activeInvoice.value;
        if (!invoice) return;

        const searchQuery = invoice.productSearchQuery.trim().toLowerCase();
        if (searchQuery === '') {
          invoice.productSearchResults = [];
          return;
        }
        fetch(
          `https://localhost:7196/api/Sanphams/searchhd/Admin?name=${encodeURIComponent(searchQuery)}`
        )
          .then(response => response.json())
          .then(data => {
            invoice.productSearchResults = data || [];
          })
          .catch(error => {
            console.error('L·ªói khi t√¨m ki·∫øm s·∫£n ph·∫©m:', error);
            invoice.productSearchResults = [];
          });
      }

      // Th√™m h√≥a ƒë∆°n
      function addInvoice() {
        if (invoices.value.length >= maxInvoices) {
          Swal.fire('Th√¥ng b√°o', 'Ch·ªâ ƒë∆∞·ª£c t·∫°o t·ªëi ƒëa 3 h√≥a ƒë∆°n.', 'warning');
          return;
        }
        const newId = Date.now();
        invoices.value.push({
          id: newId,
          products: [],
          productSearchQuery: '',
          productSearchResults: [],
          customer: {
            type: 'regular',
            name: '',
            selectedCustomerId: null,
            selectedCustomerName: '',
            searchQuery: '',
            searchResults: [],
            availablePoints: 0,
            pointsUsed: 0,
            maxPointsUsable: 0,
            vouchers: [],
            selectedVoucher: null,
            paymentMethod: null,
            cashGiven: 0,
            cashGivenFormatted: '',
          }
        });
        activeInvoiceId.value = newId;
        invoiceCount.value++;
      }
      function onQuantityInput(invoiceId, product, e) {
  const valStr = e.target.value;          // gi√° tr·ªã g·ªëc chu·ªói
  if (valStr === '') {
    // Cho ph√©p r·ªóng t·∫°m th·ªùi ƒë·ªÉ ng∆∞·ªùi d√πng ch·ªânh s·ª≠a
    product.quantity = '';                // gi·ªØ chu·ªói r·ªóng (kh√¥ng 0)
    return;
  }

  const raw = Number(valStr);
  const maxQty = product.selectedAttribute.soluong || 0;

  // K·∫πp tr·∫ßn & s√†n
  if (raw > maxQty)      product.quantity = maxQty;
  else if (raw < 1)      product.quantity = 1;
  else                   product.quantity = raw;

  updateTotal(invoiceId);
}


      function removeInvoice(invoiceId) {
        invoices.value = invoices.value.filter(inv => inv.id !== invoiceId);
        if (activeInvoiceId.value === invoiceId && invoices.value.length > 0) {
          activeInvoiceId.value = invoices.value[0].id;
        }
        invoiceCount.value--;
      }

      // Set h√≥a ƒë∆°n ƒëang ho·∫°t ƒë·ªông
      function setActiveInvoice(invoiceId) {
        activeInvoiceId.value = invoiceId;
      }

      // Reset h√≥a ƒë∆°n sau khi thanh to√°n
      function resetInvoice(invoiceId) {
        const invoiceIndex = invoices.value.findIndex(inv => inv.id === invoiceId);
        if (invoiceIndex !== -1) {
          invoices.value.splice(invoiceIndex, 1, {
            id: Date.now(),
            products: [],
            productSearchQuery: '',
            productSearchResults: [],
            customer: {
              type: 'regular',
              name: '',
              selectedCustomerId: null,
              selectedCustomerName: '',
              searchQuery: '',
              searchResults: [],
              availablePoints: 0,
              pointsUsed: 0,
              maxPointsUsable: 0,
              vouchers: [],
              selectedVoucher: null,
              paymentMethod: 'cash',
              cashGiven: 0,
              cashGivenFormatted: '',
            },
          });
          activeInvoiceId.value = invoices.value[invoiceIndex].id;
        }
      }

      onMounted(() => {
        // L·∫Øng nghe toggle-sidebar n·∫øu b·∫°n c√≥ sidebar
        window.addEventListener('toggle-sidebar', () => {
          isSidebarOpen.value = !isSidebarOpen.value;
        });
        // Kh·ªüi t·∫°o l·∫ßn ƒë·∫ßu
        handleCustomerTypeChange(invoices.value[0].id);
        loadPaymentMethods();

      });

      // Tr·∫£ v·ªÅ t·∫•t c·∫£ bi·∫øn/h√†m ƒë·ªÉ s·ª≠ d·ª•ng trong template
      return {
        invoices,
        invoiceCount,
        maxInvoices,
        activeInvoiceId,
        isSidebarOpen,

        activeInvoice,
        totalAmountBeforeDiscount,
        totalDiscount,
        totalAmount,
        changeAmount,
        onQuantityInput           ,
        paymentMethods,
        loadPaymentMethods,

        formatProductCode,
        onQuantityBlur,
        formatCurrency,
        addProductToInvoice,
        removeProduct,
        updatePrice,
        updateTotal,
        getAvailableAttributesForProduct,
        handleCustomerTypeChange,
        searchCustomer,
        selectCustomer,
        loadDiscountVouchers,
        calculateDiscount,
        applyPoints,
        onCashGivenInput,
        submitInvoice,
        fetchCustomerById,
        updateCustomerName,
        searchProduct,
        addInvoice,
        removeInvoice,
        setActiveInvoice,
        resetInvoice
      };
    }
  }).mount('#app');
  </script>
</body>
</html>