<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Hóa đơn bán hàng</title>
  <!-- CDN Bootstrap CSS -->
  <link 
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" 
    rel="stylesheet"
  />
  <!-- Bootstrap Icons -->
  <link 
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css"
  />
  <!-- SweetAlert2 CSS (nếu muốn style popup) -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css"
  />
  <style>
    /* ==== Layout cơ bản ==== */
    .main {
      display: flex;
      min-height: 100vh;
      background: #f4f4f6;     /* nền flat xám nhạt */
    }
    .main-content {
      margin-top: 60px;
      margin-left: 250px;
      flex: 1;
      padding: 20px;
      transition: margin-left 0.3s ease;
    }
    .main-content.open {
      margin-left: 0;
    }
  
    /* ==== Tiêu đề hóa đơn ==== */
    .invoice-title {
      color: #343a40;           /* đen đậm trên nền sáng */
      margin-bottom: 15px;
      font-weight: 700;
      text-align: center;
    }
  
    /* ==== Tabs hóa đơn ==== */
    .invoice-tab-item {
      display: flex;
      align-items: center;
      position: relative;
      margin-right: 10px;
    }
    .invoice-tab-item .nav-link {
      flex-grow: 1;
      padding-right: 10px;
    }
    .invoice-tab-item .close-btn {
      padding: 0;
      width: 16px;
      height: 16px;
      font-size: 0.75rem;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: #dc3545;
      color: white;
      border: none;
      cursor: pointer;
      line-height: 1;
    }
    .invoice-tab-item .close-btn:hover {
      background-color: #c82333;
    }
    .nav-tabs .nav-item {
      display: flex;
      align-items: center;
    }
    .nav-tabs .nav-link {
      padding-right: 25px; /* Đảm bảo không gian cho nút "X" */
      position: relative;
    }
  
    /* ==== Card body màu tối cho form chính ==== */
    .custom-card-body {
      padding: 20px;
      background-image: linear-gradient(#1f1f1f, #c10c9a2d);
    }
    .custom-card-header-secondary {
      background-color: #C10C99;
      color: white;
    }
  
    /* ==== Nút chính ==== */
    .custom-btn-primary {
      background-color: #28a745;   /* xanh lá */
      border-color: #28a745;
    }
    .custom-btn-primary:hover {
      background-color: #218838;
      border-color: #1e7e34;
    }
  
    /* ==== Nút nhỏ thêm hóa đơn ==== */
    .custom-btn-success {
      border-radius: 50%;
      width: 40px;
      height: 40px;
      color: white;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .custom-btn-success:hover {
      color: #C10C99;
      background-color: white;
    }
    .custom-btn-success:disabled {
      color: #585257;
    }
  
    /* ==== Search và form-control ==== */
    .row.align-items-center {
      margin-top: 1rem;
    }
    .row .form-control {
      width: calc(100% - 1rem);
      display: inline-block;
    }
  
    /* ==== Tên khách hàng hiển thị ==== */
    p.mb-0.customer-name {
      margin-left: 10px;
      display: inline-block;
      color: #343a40;           /* màu đen để nổi trên nền sáng */
    }
  
    /* ==== Danh sách kết quả tìm kiếm ==== */
    .search-results {
      max-width: 100%;
      width: 300px;
      position: absolute;
      background-color: #fff;
      border: 1px solid #ddd;
      z-index: 1000;
      border-radius: 4px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }
    .search-result-item {
      display: flex;
      align-items: center;
      padding: 5px;
      cursor: pointer;
    }
    .search-result-item:hover {
      background-color: #f0f0f0;
    }
    .search-result-item div {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
  
    /* ==== Bảng sản phẩm ==== */
    .table-invoice thead th {
      background: #343a40;       /* header tối để tương phản */
      color: #fff;
      vertical-align: middle;
    }
    .table-invoice tbody td {
      vertical-align: middle;
    }
    .quantity-input {
      max-width: 70px;
    }
  
    /* ==== Các nút cảnh báo & mặc định ==== */
    .btn-danger {
      background-color: #dc3545;
      border-color: #dc3545;
    }
    .btn-danger:hover {
      background-color: #c82333;
      border-color: #bd2130;
    }
    .btn-primary {
      background-color: #0d6efd;
      border-color: #0d6efd;
    }
    .btn-primary:hover {
      background-color: #0b5ed7;
      border-color: #0a58ca;
    }
  
    /* ==== Card chung ==== */
    .card-flat {
      border: 1px solid #dee2e6;
      border-radius: .4rem;
      background: #fff;
      margin-bottom: 1rem;
    }
    .card-flat .card-header {
      background: #343a40;
      color: #fff;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .card-flat .card-body {
      padding: 1rem;
    }
  
    /* ==== Container ==== */
    .container {
      max-width: 100vw;
      margin: 0;
      padding: 0;
    }
  
    /* ==== Close button trên tab ==== */
    .customCloseBtn {
      position: absolute;
      right: 10px;
      top: 13px;
      background-color: transparent !important;
      color: #C10C99 !important;
    }
  
    /* ==== Link tab ==== */
    .customNavlink {
      color: #C10C99;
    }
    .custom-card-body {
  background: #1f1f1f!important;
  background-image: none !important;
  padding: 100px; /* nếu bạn muốn padding của .card-body mặc định */
}
/* ==== Tab “Thêm hóa đơn chờ” ==== */
.add-tab-item {
  margin-right: 0; /* không cần khoảng cách thừa */
}
.add-tab-item .custom-add-tab {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 40px;
  height: 40px;
  padding: 0;
  border: 1px solid #dee2e6;
  border-bottom-color: transparent;            /* để gắn với phần content */
  border-top-left-radius: .25rem;
  border-top-right-radius: .25rem;
  background-color: #e9ecef;                   /* giống tab inactive */
  color: #6c757d;                               /* xám đậm */
  cursor: pointer;
}

/* hover */
.add-tab-item .custom-add-tab:hover:not(:disabled) {
  background-color: #dee2e6;
  color: #495057;
}

/* trạng thái disabled */
.add-tab-item .custom-add-tab:disabled {
  opacity: .5;
  cursor: not-allowed;
}

</style>
  
</head>
<body>
  <div id="app">
    <!-- ====== Phần template chính, copy từ <template> trong .vue ====== -->
    <div class="main">
      <main :class="{ open: !isSidebarOpen }" class="main-content">
        <div class="container">
          <h1 class="invoice-title">Tạo hóa đơn bán hàng</h1>
          <div >
            <div class="card-body custom-card-body">
              <!-- Tabs for Invoices -->
              <ul class="nav nav-tabs mb-3" id="invoice-tabs" role="tablist">
                <li
                  class="nav-item invoice-tab-item"
                  v-for="(invoice, index) in invoices"
                  :key="invoice.id"
                >
                  <a
                    class="nav-link flex-grow-1 customNavlink"
                    :class="{ active: activeInvoiceId === invoice.id }"
                    href="#"
                    @click.prevent="setActiveInvoice(invoice.id)"
                    style="padding-right: 35px;"
                  >
                    Hóa đơn {{ index + 1 }}
                     <span
        class="tab-close"
        @click.stop.prevent="removeInvoice(invoice.id)"
        title="Xóa hóa đơn"
      >×</span>
                  </a>
                  <button
                    class="btn btn-danger btn-sm close-btn ms-2 customCloseBtn"
                    @click.prevent="removeInvoice(invoice.id)"
                    title="Xóa Hóa đơn"
                  >
                    <i class="pi pi-times" style="font-size: 12px;"></i>
                  </button>
                </li>
                <li class="nav-item add-tab-item">
                  <button
                    class="nav-link custom-add-tab"
                    title="Thêm hóa đơn chờ"
                    @click="addInvoice"
                    :disabled="invoices.length >= maxInvoices"
                  >
                    <i class="bi bi-file-earmark-plus" style="font-size: 1.2rem;"></i>
                  </button>
                </li>
                
              </ul>

              <!-- Main Content Row -->
              <div class="row">
                <div class="col-lg-4 col-md-5 col-sm-12">
                  <div class="card card-flat mb-4">
                    <div class="card-header header-dark">
                      <span>Thông tin khách hàng</span>
                      <i class="bi bi-person-fill"></i>
                    </div>
                
                    <div class="card-body">
                      <form>
                        <!-- Customer Type -->
                        <div class="mb-3">
                          <label for="customerType" class="form-label"><strong>Loại Khách Hàng:</strong></label>
                          <select
                            class="form-select"
                            id="customerType"
                            v-model="activeInvoice.customer.type"
                            @change="handleCustomerTypeChange(activeInvoice.id)"
                          >
                            <option value="regular">Khách Lẻ</option>
                            <option value="loyal">Khách Hàng Thân Thiết</option>
                          </select>
                        </div>

                        <!-- Customer Name for Regular Customers -->
                        <div class="mb-3" v-if="activeInvoice.customer.type === 'regular'">
                          <label for="customerName" class="form-label"><strong>Tên Khách Hàng:</strong></label>
                          <input
                            type="text"
                            class="form-control"
                            id="customerName"
                            v-model="activeInvoice.customer.name"
                            placeholder="Nhập tên khách hàng"
                            @input="updateCustomerName(activeInvoice.id)"
                          />
                        </div>

                        <!-- Customer Search for Loyal Customers -->
                        <div class="mb-3 position-relative" v-else>
                          <label for="customerSearch" class="form-label"><strong>Tìm Kiếm Khách Hàng:</strong></label>
                          <input
                            type="text"
                            class="form-control"
                            id="customerSearch"
                            v-model="activeInvoice.customer.searchQuery"
                            placeholder="Tìm kiếm tên, SĐT, email..."
                            @input="searchCustomer(activeInvoice.id)"
                            autocomplete="off"
                          />
                          <div v-if="activeInvoice.customer.searchResults.length" class="mt-1 search-results shadow">
                            <div
                              v-for="customer in activeInvoice.customer.searchResults"
                              :key="customer.id"
                              class="search-result-item p-2 border-bottom bg-white"
                              @click="selectCustomer(activeInvoice.id, customer)"
                            >
                              <strong>{{ customer.ten }}</strong> - {{ customer.sdt }} - {{ customer.email }}
                            </div>
                          </div>
                        </div>

                        <!-- Payment Method -->
                        <div class="mb-3">
                          <label for="paymentMethod" class="form-label"><strong>Phương Thức Thanh Toán:</strong></label>
                          <select
                          class="form-select"
                          id="paymentMethod"
                          v-model="activeInvoice.customer.paymentMethod"
                        >
                          <option
                            v-for="pt in paymentMethods"
                            :key="pt.id"
                            :value="pt.id"
                          >
                            {{ pt.tenpttt }}
                          </option>
                        </select>
                        
                        </div>

                        <!-- Vouchers for Loyal Customers -->
                        <div class="mb-3" v-if="activeInvoice.customer.type === 'loyal'">
                          <label for="selectedVoucher" class="form-label"><strong>Giảm Giá:</strong></label>
                          <select
                            class="form-select"
                            id="selectedVoucher"
                            v-model="activeInvoice.customer.selectedVoucher"
                            @change="calculateDiscount(activeInvoice.id)"
                          >
                            <option value="">Chọn giảm giá</option>
                            <option
                              v-for="voucher in activeInvoice.customer.vouchers"
                              :key="voucher.id"
                              :value="voucher"
                            >
                              {{ voucher.mota }}
                            </option>
                          </select>
                        </div>

                       
                      </form>

                      <hr />

                      <div class="invoice-summary">
                        <p>
                          <strong>Tổng tiền hàng:</strong>
                          <span class="float-end">{{ formatCurrency(totalAmountBeforeDiscount) }}</span>
                        </p>
                        <p>
                          <strong>Tổng Giảm Giá:</strong>
                          <span class="float-end">{{ formatCurrency(totalDiscount) }}</span>
                        </p>
                        <p>
                          <strong>Tổng tiền thanh toán:</strong>
                          <span class="float-end">{{ formatCurrency(totalAmount) }}</span>
                        </p>
                         <!-- Points Used for Loyal Customers -->
                         <div class="mb-3" v-if="activeInvoice.customer.type === 'loyal'">
                          <label for="pointsUsed" class="form-label"><strong>Điểm Sử Dụng:</strong></label>
                          <div class="d-flex justify-content-between align-items-center">
                            <span>Điểm có thể sử dụng: {{ activeInvoice.customer.availablePoints }}</span>
                            <input
                              type="number"
                              class="form-control w-50"
                              id="pointsUsed"
                              v-model.number="activeInvoice.customer.pointsUsed"
                              @input="applyPoints(activeInvoice.id)"
                              min="0"
                              :max="activeInvoice.customer.availablePoints"
                              placeholder="0"
                            />
                          </div>
                        </div>
                        <div class="mb-3 mt-3">
                          <label for="cashGiven" class="form-label"><strong>Số Tiền Khách Đưa:</strong></label>
                          <input
                            type="text"
                            class="form-control"
                            id="cashGiven"
                            v-model="activeInvoice.customer.cashGivenFormatted"
                            placeholder="Nhập số tiền khách đưa"
                            @input="onCashGivenInput(activeInvoice.id)"
                          />
                        </div>
                        <p>
                          <strong>Tiền thừa:</strong>
                          <span class="float-end">{{ formatCurrency(changeAmount) }}</span>
                        </p>
                        <button
                          class="btn custom-btn-primary w-100 mt-3"
                          @click="submitInvoice"
                        >
                          Thanh toán
                        </button>
                      </div>
                    </div>
                  </div> <!-- End of .row -->
                </div>

                <div class="col-lg-8 col-md-7 col-sm-12">
                  <div class="row align-items-center mb-3">
                    <div class="position-relative w-100">
                      <input
                        type="text"
                        class="form-control"
                        v-model="activeInvoice.productSearchQuery"
                        placeholder="Tìm kiếm sản phẩm..."
                        @input="searchProduct"
                        autocomplete="off"
                        style="min-width: 100%;"
                      />
                      <p class="mb-2 customer-name" style="color: white; margin-top: 20px;">
                        <strong>Tên khách hàng:</strong> {{ activeInvoice.customer.selectedCustomerName || 'Chưa chọn' }}
                      </p>
                      <div v-if="activeInvoice.productSearchResults.length" class="search-results">
                        <div
                          v-for="product in activeInvoice.productSearchResults"
                          :key="product.id"
                          class="search-result-item"
                          @click="addProductToInvoice(product)"
                        >
                      
                          <div>
                            <strong> {{ formatProductCode(product.id) }} - {{ product.tenSanpham }}</strong>
                            <br />
                            {{ formatCurrency(product.giaBan) }}
                            <br />
                            Tồn kho: {{ product.soluong }}
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>

                  <div class="card card-flat">
                    <div class="card-header header-dark">
                      Danh sách sản phẩm
                    </div>
                    <div class="card-body p-0">
                      <div class="table-responsive">
                        <table class="table table-hover m-0 table-invoice">
                          <thead>
                            <tr>
                              <th>Tên SP</th>
                              <th>Giá bán</th>
                              <th>Giá giảm</th>
                              <th>Phân loại</th>
                              <th class="text-center">SL</th>
                              <th>Thành tiền</th>
                              <th></th>
                            </tr>
                          </thead>
                          
                      <tbody>
                        <tr
                          v-for="item in activeInvoice.products || []"
                          :key="item.id"
                        >
                          <td>{{ item.tensp }}</td>
                          <td>{{ formatCurrency(item.giaban) }}</td>
                          <td>{{ formatCurrency(item.giagiam) }}</td>
                          <td>
                            <select
                              class="form-select form-select-sm attribute-select"
                              v-model="item.selectedAttribute.idspct"
                              @change="updatePrice(activeInvoice.id, item)"
                              :disabled="item.isLocked"
                            >
                              <option
                                v-for="attr in getAvailableAttributesForProduct(item)"
                                :key="attr.idspct"
                                :value="attr.idspct"
                              >
                                {{ attr.spctAttributes }}
                              </option>
                            </select>
                          </td>
                          <td>
                            <input
                            type="number"
                            class="form-control form-control-sm quantity-input"
                            v-model.number="item.quantity"
                            @input="onQuantityInput(activeInvoice.id, item, $event)"
                            @blur="onQuantityBlur(activeInvoice.id, item)"   
                            min="1"
                          />

                          </td>
                          <td>{{ formatCurrency(item.totalPrice) }}</td>
                          <td>
                            <button
                              class="btn btn-danger btn-sm"
                              @click="removeProduct(activeInvoice.id, item.id)"
                            >
                              Xóa
                            </button>
                          </td>
                        </tr>
                        <tr v-if="activeInvoice.products.length === 0">
                          <td colspan="7" class="text-center">Chưa có sản phẩm nào trong hóa đơn.</td>
                        </tr>
                      </tbody>
                    </table>
                  </div>
                </div>

              </div> <!-- End of .row -->
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>


  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
  <!-- Bootstrap Bundle (bao gồm Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
  // ====== Code logic, thay thế "script setup" bằng createApp() ======
  const { createApp, ref, computed, onMounted } = Vue;

  createApp({
    setup() {
      // Khởi tạo danh sách hóa đơn
      const invoices = ref([
        {
          id: 1,
          products: [],
          productSearchQuery: '',
          productSearchResults: [],
          customer: {
            type: 'regular',
            name: '',
            selectedCustomerId: null,
            selectedCustomerName: '',
            searchQuery: '',
            searchResults: [],
            availablePoints: 0,
            pointsUsed: 0,
            maxPointsUsable: 0,
            vouchers: [],
            selectedVoucher: null,
            paymentMethod: 'cash',
            cashGiven: 0,
            cashGivenFormatted: '',
          }
        }
      ]);
      const ACCOUNT_NAME = 'DOAN THI PHUONG THAO';
      const ACCOUNT_NO   = '1023577418';
      const BANK_CODE    = 'VCB';       
      const BANK_TRANSFER_ID = 2;
      const paymentMethods = ref([]); 
      const invoiceCount = ref(1);
      const maxInvoices = 3;
      const activeInvoiceId = ref(1);
      const isSidebarOpen = ref(true);

      const activeInvoice = computed(() => invoices.value.find(inv => inv.id === activeInvoiceId.value));
      const totalAmountBeforeDiscount = computed(() => {
        if (!activeInvoice.value) return 0;
        return activeInvoice.value.products.reduce((sum, p) => sum + p.totalPrice, 0);
      });
      const voucherDiscount = computed(() => {
        if (!activeInvoice.value) return 0;
        const invoice = activeInvoice.value;
        let discount = 0;
        if (invoice.customer.selectedVoucher) {
          const v = invoice.customer.selectedVoucher;
          if (v.donvi === 0) {
            discount = v.giatri;
          } else if (v.donvi === 1) {
            discount = (totalAmountBeforeDiscount.value * v.giatri) / 100;
          }
        }
        return Math.min(discount, totalAmountBeforeDiscount.value);
      });
      const totalDiscount = computed(() => {
        if (!activeInvoice.value) return 0;
        return Math.min(voucherDiscount.value + activeInvoice.value.customer.pointsUsed, totalAmountBeforeDiscount.value);
      });

      const totalAmount = computed(() => totalAmountBeforeDiscount.value - totalDiscount.value);

      const changeAmount = computed(() => {
        if (!activeInvoice.value) return 0;
        return (activeInvoice.value.customer.cashGiven || 0) - totalAmount.value;
      });

      
      async function loadPaymentMethods() {
        try {
          const res = await fetch(
            "https://localhost:7196/api/Phuongthucthanhtoans/active"
          );
          if (!res.ok) throw new Error("Không thể lấy phương thức thanh toán");
          paymentMethods.value = await res.json();   
          console.log( paymentMethods.value )
        } catch (err) {
          console.error(err);
          paymentMethods.value = [];                 
        }
      }

      function formatProductCode(id) {
        return 'SP' + String(id).padStart(5, '0');
      }

      function formatCurrency(amount) {
        return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
      }

      // Hàm thêm sản phẩm vào hóa đơn (với yêu cầu chọn phân loại)
      async function addProductToInvoice(product) {
        const invoice = activeInvoice.value;
        if (!invoice) {
          Swal.fire('Lỗi', 'Không tìm thấy hóa đơn hiện tại.', 'error');
          return;
        }

        try {
          const response = await fetch(
            `https://localhost:7196/api/Sanphams/active-products-with-attributes/Admin?id=${product.id}`
          );
          let attributesData = await response.json();

          // Lọc các phân loại đã được thêm vào hóa đơn
          const existingAttributes = invoice.products
            .filter(p => p.productId === product.id)
            .map(p => p.selectedAttribute.idspct);
          const availableAttributes = attributesData.filter(
            attr => !existingAttributes.includes(attr.idspct)
          );

          if (availableAttributes.length === 0) {
            Swal.fire(
              'Thông báo',
              'Tất cả phân loại của sản phẩm này đã được thêm vào hóa đơn!',
              'info'
            );
            return;
          }

          // Tạo đối tượng cho lựa chọn phân loại
          const classificationOptions = availableAttributes.reduce((options, attr) => {
            options[attr.idspct] = attr.spctAttributes;
            return options;
          }, {});

          // Hiển thị hộp thoại chọn phân loại
          const { value: selectedId } = await Swal.fire({
            title: 'Chọn phân loại sản phẩm',
            input: 'select',
            inputOptions: classificationOptions,
            inputPlaceholder: 'Chọn phân loại',
            showCancelButton: true,
            inputValidator: (value) => {
              return new Promise((resolve) => {
                if (value) {
                  resolve();
                } else {
                  resolve('Bạn cần chọn một phân loại!');
                }
              });
            },
          });

          if (!selectedId) {
            // Người dùng hủy hoặc không chọn
            return;
          }

          // selectedId từ string => number
          const selectedAttribute = availableAttributes.find(
            attr => attr.idspct === Number(selectedId)
          );
          if (!selectedAttribute) {
            Swal.fire('Lỗi', 'Phân loại không hợp lệ.', 'error');
            return;
          }

          const productPrice = selectedAttribute.giathoidiemhientai || product.giaBan;
          const newProduct = {
            id: Date.now(), // ID duy nhất cho sản phẩm trong hóa đơn
            productId: product.id,
            tensp: product.tenSanpham,
            giaban: product.giaBan,
            giagiam: productPrice,
            attributes: availableAttributes,
            selectedAttribute: selectedAttribute,
            quantity: 1,
            totalPrice: productPrice,
            isLocked: true 
          };

          invoice.products.push(newProduct);
          invoice.productSearchQuery = '';
          invoice.productSearchResults = [];

          Swal.fire('Thành công', 'Đã thêm sản phẩm với phân loại đã chọn.', 'success');
        } catch (error) {
          console.error('Lỗi khi lấy thuộc tính sản phẩm:', error);
          Swal.fire(
            'Lỗi',
            'Không thể lấy thuộc tính của sản phẩm. Vui lòng thử lại sau.',
            'error'
          );
        }
      }
      function buildVietQR(amount, description = 'THANH TOAN HOA DON') {
  const params = new URLSearchParams({
    amount: amount,                                 // số tiền VND
    addInfo: description.replace(/\s+/g, '%20'),    // nội dung chuyển khoản
    accountName: ACCOUNT_NAME.replace(/\s+/g, '%20')
  }).toString();

  // URL tới ảnh QR dạng png, host bởi VietQR.io
  return `https://img.vietqr.io/image/${BANK_CODE}-${ACCOUNT_NO}-qr_only.png?${params}`;
}


      function removeProduct(invoiceId, productId) {
        const invoice = invoices.value.find(inv => inv.id === invoiceId);
        if (invoice) {
          invoice.products = invoice.products.filter(p => p.id !== productId);
        }
      }

      // Cập nhật giá khi đổi phân loại
      function updatePrice(invoiceId, product) {
        const invoice = invoices.value.find(inv => inv.id === invoiceId);
        if (invoice) {
          const selectedAttr = invoice.products
            .find(p => p.id === product.id)
            .attributes.find(attr => attr.idspct === product.selectedAttribute.idspct);
          if (selectedAttr) {
            product.giagiam = selectedAttr.giathoidiemhientai || product.giaban;
            product.totalPrice = product.giagiam * product.quantity;
          }
        }
      }

      // Cập nhật tổng tiền khi thay đổi số lượng
      function updateTotal(invoiceId) {
        const invoice = invoices.value.find(inv => inv.id === invoiceId);
        if (invoice) {
          invoice.products.forEach(product => {
            const qty = Number(product.quantity) || 0;   // ép sang số, '' → 0
  product.totalPrice = product.giagiam * qty;
          });
        }
      }

      // Lấy phân loại khả dụng cho sản phẩm trong bảng
      function getAvailableAttributesForProduct(product) {
        const existingAttributes = activeInvoice.value.products
          .filter(p => p.productId === product.productId && p.id !== product.id)
          .map(p => p.selectedAttribute.idspct);
        return product.attributes.filter(attr => !existingAttributes.includes(attr.idspct));
      }

      // Thay đổi loại khách hàng
      function handleCustomerTypeChange(invoiceId) {
        const invoice = invoices.value.find(inv => inv.id === invoiceId);
        if (!invoice) return;
        invoice.customer.selectedCustomerId = null;
        invoice.customer.selectedCustomerName = '';
        invoice.customer.selectedVoucher = null;
        invoice.customer.vouchers = [];
        invoice.customer.pointsUsed = 0;

        if (invoice.customer.type === 'regular') {
          invoice.customer.availablePoints = 0;
        } else if (invoice.customer.type === 'loyal') {
          // Nếu cần logic khác thì đặt ở đây
        }
      }

      // Tìm kiếm khách hàng
      function searchCustomer(invoiceId) {
        const invoice = invoices.value.find(inv => inv.id === invoiceId);
        if (!invoice) return;

        const searchQuery = invoice.customer.searchQuery.trim().toLowerCase();
        if (searchQuery === '') {
          invoice.customer.searchResults = [];
          return;
        }
        fetch(
          `https://localhost:7196/api/Khachhangs/searchByEmailSdtTen/Admin?keyword=${encodeURIComponent(searchQuery)}`
        )
          .then(response => response.json())
          .then(data => {
            invoice.customer.searchResults = data || [];
          })
          .catch(error => {
            console.error('Lỗi khi tìm kiếm khách hàng:', error);
            invoice.customer.searchResults = [];
          });
      }

      // Chọn khách hàng
      function selectCustomer(invoiceId, customer) {
        const invoice = invoices.value.find(inv => inv.id === invoiceId);
        if (invoice) {
          invoice.customer.selectedCustomerId = customer.id;
          invoice.customer.selectedCustomerName = customer.ten;
          invoice.customer.availablePoints = customer.diemsudung || 0;
          invoice.customer.pointsUsed = 0; // reset khi chọn khách mới

          loadDiscountVouchers(invoiceId, customer.id);

          // Xóa nội dung tìm kiếm
          invoice.customer.searchQuery = '';
          invoice.customer.searchResults = [];
        }
      }

      // Lấy voucher giảm giá theo khách hàng
      function loadDiscountVouchers(invoiceId, customerId) {
        fetch(`https://localhost:7196/api/Giamgia/vouchers-by-customer/${customerId}/admin`)
          .then(response => response.json())
          .then(data => {
            const invoice = invoices.value.find(inv => inv.id === invoiceId);
            if (invoice) {
              const activeVouchers = data.filter(voucher => voucher.trangthai === 0);
              invoice.customer.vouchers = activeVouchers;
              if (activeVouchers.length === 0) {
                invoice.customer.vouchers = [];
              }
            }
          })
          .catch(error => {
            console.error('Error fetching vouchers by customer:', error);
            const invoice = invoices.value.find(inv => inv.id === invoiceId);
            if (invoice) {
              invoice.customer.vouchers = [];
            }
          });
      }

      // Tính toán giảm giá dựa trên voucher
      function calculateDiscount(invoiceId) {
        const invoice = invoices.value.find(inv => inv.id === invoiceId);
        if (invoice) {
          const selectedVoucher = invoice.customer.selectedVoucher;
          if (selectedVoucher) {
            let discount = 0;
            if (selectedVoucher.donvi === 0) {
              discount = selectedVoucher.giatri;
            } else if (selectedVoucher.donvi === 1) {
              discount = (totalAmountBeforeDiscount.value * selectedVoucher.giatri) / 100;
            }
            invoice.customer.discount = Math.min(
              discount,
              totalAmountBeforeDiscount.value
            );
          }
        }
      }
      function applyPoints(invoiceId) {
        const invoice = invoices.value.find(inv => inv.id === invoiceId);
        if (!invoice) return;
        const available = invoice.customer.availablePoints;
        const maxByAmount = totalAmountBeforeDiscount.value - voucherDiscount.value;
        const requested = Number(invoice.customer.pointsUsed) || 0;
        invoice.customer.pointsUsed = Math.max(0, Math.min(requested, available, maxByAmount));
      }


      // Xử lý nhập số tiền khách đưa
      function onCashGivenInput(invoiceId) {
        const invoice = invoices.value.find(inv => inv.id === invoiceId);
        if (!invoice) return;

        let value = invoice.customer.cashGivenFormatted.replace(/\D/g, '');
        if (value.length === 0) {
          invoice.customer.cashGiven = 0;
          invoice.customer.cashGivenFormatted = '';
          return;
        }

        const numericValue = parseInt(value, 10) || 0;
        invoice.customer.cashGiven = numericValue;
        invoice.customer.cashGivenFormatted = numericValue.toLocaleString('vi-VN');
      }
function onQuantityBlur(invoiceId, product) {
  // Nếu người dùng bỏ trống rồi click ra ngoài → set về 1
  if (product.quantity === '' || product.quantity === null || product.quantity === undefined) {
    product.quantity = 1;
  }
  updateTotal(invoiceId);    // luôn tính lại thành tiền
}
      // Gửi yêu cầu tạo hóa đơn
      async function submitInvoice() {
        const invoice = activeInvoice.value;
        if (!invoice) {
          Swal.fire('Lỗi', 'Không tìm thấy hóa đơn hiện tại.', 'error');
          return;
        }
        if (!invoice.products || invoice.products.length === 0) {
          Swal.fire('Lỗi', 'Hóa đơn chưa có sản phẩm. Vui lòng thêm sản phẩm.', 'warning');
          return;
        }
        if (invoice.customer.type === 'loyal' && !invoice.customer.selectedCustomerId) {
          Swal.fire('Lỗi', 'Vui lòng chọn thông tin khách hàng thân thiết.', 'warning');
          return;
        }
        if (invoice.customer.paymentMethod !== BANK_TRANSFER_ID &&
      invoice.customer.cashGiven < totalAmount.value) {
    Swal.fire('Lỗi', 'Số tiền khách đưa không đủ.', 'error'); return;
  }
  if (invoice.customer.paymentMethod === BANK_TRANSFER_ID) {
    const qrUrl = buildVietQR(totalAmount.value);

    const { isConfirmed } = await Swal.fire({
      title: 'Quét mã để chuyển khoản',
      html: `
        <img src="${qrUrl}" style="width:260px;height:260px;margin-bottom:10px"/>
        <p>👉 Vui lòng chuyển đúng <b>${formatCurrency(totalAmount.value)}</b><br/>
           Nội dung: THANH TOAN HOA DON</p>`,
      showCancelButton: true,
      confirmButtonText: 'Đã chuyển xong',
      cancelButtonText: 'Hủy'
    });

    if (!isConfirmed) return;   // Khách hủy thì dừng
  }

        // Dữ liệu chi tiết sản phẩm
        const productDetails = invoice.products.map(product => ({
          idspct: product.selectedAttribute.idspct,
          soluong: product.quantity,
          giasp: product.giaban,
          giamgia: product.selectedAttribute.giathoidiemhientai,
        }));

        let requestData;
        let apiUrl;
        if (invoice.customer.type === 'loyal') {
          const customerData = await fetchCustomerById(invoice.customer.selectedCustomerId);
          if (!customerData) {
            Swal.fire('Lỗi', 'Không thể lấy thông tin khách hàng thân thiết.', 'error');
            return;
          }
          const diemSuDung = invoice.customer.pointsUsed || 0; 
          apiUrl = `https://localhost:7196/api/Hoadons/create/khtt?diemSuDung=${diemSuDung}`;

          requestData = {
            idnv: 1,
            idkh: invoice.customer.selectedCustomerId || null,
            
            idpttt: invoice.customer.paymentMethod,
            tongtiencantra: totalAmount.value,
            tongtiensanpham: totalAmountBeforeDiscount.value,
            sdt: customerData || '',
            tonggiamgia: totalDiscount.value,
            idgg: invoice.customer.selectedVoucher ? invoice.customer.selectedVoucher.id : null,
            ghichu: '',
            sanPhamChiTiet: productDetails,
          };
        } else {
          apiUrl = 'https://localhost:7196/api/Hoadons/create/Admin';
          requestData = {
            idnv: 1,
            idpttt: invoice.customer.paymentMethod,
            tongtiencantra: totalAmount.value,
            tongtiensanpham: totalAmountBeforeDiscount.value,
            ghichu: '',
            sanPhamChiTiet: productDetails,
          };
        }

        try {
          const response = await fetch(apiUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestData),
          });
          if (!response.ok) {
            const error = await response.json();
            Swal.fire(
              'Lỗi',
              error.message || 'Không thể tạo hóa đơn. Vui lòng thử lại sau.',
              'error'
            );
            return;
          }
          Swal.fire({
            icon: 'success',
            title: 'Tạo hóa đơn thành công!',
            text: 'Hóa đơn đã được lưu.',
            confirmButtonText: 'Đóng',
          }).then(() => {
            resetInvoice(activeInvoiceId.value);
          });
        } catch (error) {
          console.error('Lỗi khi gửi yêu cầu:', error);
          Swal.fire('Lỗi', 'Không thể gửi yêu cầu. Vui lòng kiểm tra lại API.', 'error');
        }
      }

      // Lấy khách hàng theo ID
      async function fetchCustomerById(idkh) {
        try {
          const response = await fetch(
            `https://localhost:7196/api/Khachhangs/${idkh}/Admin`,
            {
              method: 'GET',
              headers: { 'Content-Type': 'application/json' },
            }
          );
          if (!response.ok) {
            const error = await response.json();
            console.error('Lỗi khi lấy thông tin khách hàng:', error);
            return null;
          }
          const customerData = await response.json();
          return customerData.sdt;
        } catch (error) {
          console.error('Lỗi khi gọi API:', error);
          return null;
        }
      }

      // Cập nhật tên khách hàng (Khách lẻ)
      function updateCustomerName(invoiceId) {
        const invoice = invoices.value.find(inv => inv.id === invoiceId);
        if (invoice) {
          invoice.customer.selectedCustomerName = invoice.customer.name;
        }
      }

      // Tìm kiếm sản phẩm
      function searchProduct() {
        const invoice = activeInvoice.value;
        if (!invoice) return;

        const searchQuery = invoice.productSearchQuery.trim().toLowerCase();
        if (searchQuery === '') {
          invoice.productSearchResults = [];
          return;
        }
        fetch(
          `https://localhost:7196/api/Sanphams/searchhd/Admin?name=${encodeURIComponent(searchQuery)}`
        )
          .then(response => response.json())
          .then(data => {
            invoice.productSearchResults = data || [];
          })
          .catch(error => {
            console.error('Lỗi khi tìm kiếm sản phẩm:', error);
            invoice.productSearchResults = [];
          });
      }

      // Thêm hóa đơn
      function addInvoice() {
        if (invoices.value.length >= maxInvoices) {
          Swal.fire('Thông báo', 'Chỉ được tạo tối đa 3 hóa đơn.', 'warning');
          return;
        }
        const newId = Date.now();
        invoices.value.push({
          id: newId,
          products: [],
          productSearchQuery: '',
          productSearchResults: [],
          customer: {
            type: 'regular',
            name: '',
            selectedCustomerId: null,
            selectedCustomerName: '',
            searchQuery: '',
            searchResults: [],
            availablePoints: 0,
            pointsUsed: 0,
            maxPointsUsable: 0,
            vouchers: [],
            selectedVoucher: null,
            paymentMethod: null,
            cashGiven: 0,
            cashGivenFormatted: '',
          }
        });
        activeInvoiceId.value = newId;
        invoiceCount.value++;
      }
      function onQuantityInput(invoiceId, product, e) {
  const valStr = e.target.value;          // giá trị gốc chuỗi
  if (valStr === '') {
    // Cho phép rỗng tạm thời để người dùng chỉnh sửa
    product.quantity = '';                // giữ chuỗi rỗng (không 0)
    return;
  }

  const raw = Number(valStr);
  const maxQty = product.selectedAttribute.soluong || 0;

  // Kẹp trần & sàn
  if (raw > maxQty)      product.quantity = maxQty;
  else if (raw < 1)      product.quantity = 1;
  else                   product.quantity = raw;

  updateTotal(invoiceId);
}


      function removeInvoice(invoiceId) {
        invoices.value = invoices.value.filter(inv => inv.id !== invoiceId);
        if (activeInvoiceId.value === invoiceId && invoices.value.length > 0) {
          activeInvoiceId.value = invoices.value[0].id;
        }
        invoiceCount.value--;
      }

      // Set hóa đơn đang hoạt động
      function setActiveInvoice(invoiceId) {
        activeInvoiceId.value = invoiceId;
      }

      // Reset hóa đơn sau khi thanh toán
      function resetInvoice(invoiceId) {
        const invoiceIndex = invoices.value.findIndex(inv => inv.id === invoiceId);
        if (invoiceIndex !== -1) {
          invoices.value.splice(invoiceIndex, 1, {
            id: Date.now(),
            products: [],
            productSearchQuery: '',
            productSearchResults: [],
            customer: {
              type: 'regular',
              name: '',
              selectedCustomerId: null,
              selectedCustomerName: '',
              searchQuery: '',
              searchResults: [],
              availablePoints: 0,
              pointsUsed: 0,
              maxPointsUsable: 0,
              vouchers: [],
              selectedVoucher: null,
              paymentMethod: 'cash',
              cashGiven: 0,
              cashGivenFormatted: '',
            },
          });
          activeInvoiceId.value = invoices.value[invoiceIndex].id;
        }
      }

      onMounted(() => {
        // Lắng nghe toggle-sidebar nếu bạn có sidebar
        window.addEventListener('toggle-sidebar', () => {
          isSidebarOpen.value = !isSidebarOpen.value;
        });
        // Khởi tạo lần đầu
        handleCustomerTypeChange(invoices.value[0].id);
        loadPaymentMethods();

      });

      // Trả về tất cả biến/hàm để sử dụng trong template
      return {
        invoices,
        invoiceCount,
        maxInvoices,
        activeInvoiceId,
        isSidebarOpen,

        activeInvoice,
        totalAmountBeforeDiscount,
        totalDiscount,
        totalAmount,
        changeAmount,
        onQuantityInput           ,
        paymentMethods,
        loadPaymentMethods,

        formatProductCode,
        onQuantityBlur,
        formatCurrency,
        addProductToInvoice,
        removeProduct,
        updatePrice,
        updateTotal,
        getAvailableAttributesForProduct,
        handleCustomerTypeChange,
        searchCustomer,
        selectCustomer,
        loadDiscountVouchers,
        calculateDiscount,
        applyPoints,
        onCashGivenInput,
        submitInvoice,
        fetchCustomerById,
        updateCustomerName,
        searchProduct,
        addInvoice,
        removeInvoice,
        setActiveInvoice,
        resetInvoice
      };
    }
  }).mount('#app');
  </script>
</body>
</html>